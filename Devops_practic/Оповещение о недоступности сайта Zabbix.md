## Оповещение о недоступности сайта

Давайте настроим уведомления о проблемах на сайте. Я предлагаю 2 типа оповещения:

1.  О низкой скорости доступа к сайту.
2.  О недоступности сайта вообще.

Идем, как обычно в исходный шаблон, на вкладку **Triggers** и добавляем новый.

[![Добавление триггера](https://serveradmin.ru/wp-content/uploads/2019/03/zabbix-site-monitoring-20.png)](https://serveradmin.ru/wp-content/uploads/2019/03/zabbix-site-monitoring-20.png)

Я предлагаю вот такое условие срабатывания для определения недоступности сайта. Если среднее значение 3-х последних проверок больше, либо равно единице, то срабатывает оповещение о недоступности сайта.

[![Уведомление о недоступности сайта](https://serveradmin.ru/wp-content/uploads/2019/03/zabbix-site-monitoring-21.png)](https://serveradmin.ru/wp-content/uploads/2019/03/zabbix-site-monitoring-21.png)

Когда идет 0 во всех проверках, все в порядке. Триггер сработает только если все 3 последних проверки не равны нулю. В моем примере Failed step может принимать значение либо 0, либо 1, где 1 это номер сбойного шага. Если у вас шагов несколько, то сбойным может оказаться второй шаг или третий шаг. То есть значение может быть больше 1. Но в любом случае, если последние 3 значения подряд строго не 0, то идет срабатывание триггера. Операция восстановления очень простая. Если последняя проверка без ошибки, то есть код равен 0, то считаем, что сайт уже работает.

Чтобы проверить работу триггера, достаточно на zabbix server в файл /etc/hosts добавить строку:

127.0.0.1 github.com

и подождать 3 минуты, чтобы получились 3 неудачных проверки. После этого вам должно было отправиться уведомление о недоступности сайта. Я получил вот такое:

[![Уведомление от заббикса о недоступности сайта](https://serveradmin.ru/wp-content/uploads/2019/03/zabbix-site-monitoring-24.png)](https://serveradmin.ru/wp-content/uploads/2019/03/zabbix-site-monitoring-24.png)

Дальше делаем проверку времени ответа сервера. Тут каждый волен настраивать так, как ему кажется более правильным и удобным. Я использую такую схему. Беру среднее время отклика сайта и умножаю его на 3. Далее смотрю последние 7 проверок. Если в 5 проверках среди этих семи были значения выше, чем утроенное среднее время отклика, то считаю, что сайт тормозит и надо слать уведомление. Немного замороченно, но на практике такая схема у меня себя хорошо зарекомендовала без ложных срабатываний. При этом, если возникают реальные проблемы, я их вижу. Рисуем триггер.

[![Оповещение о тормозах сайта](https://serveradmin.ru/wp-content/uploads/2019/03/zabbix-site-monitoring-22.png)](https://serveradmin.ru/wp-content/uploads/2019/03/zabbix-site-monitoring-22.png)

Условие восстановления - в последних трех запросах два и более были быстрее, чем утроенное среднее время доступа. Текст выражений для копирования:

{Sites Monitoring:web.test.time[github.com,index,resp].count(#7,1.5,"ge")}>4
{Sites Monitoring:web.test.time[github.com,index,resp].count(#3,1.5,"lt")}>1

В выражении 1.5 это время отклика в секундах. Именно в таком виде оно попадает в zabbix сервер. Проверить можно в **Latest Data**.

[![Формат данных по отклику сайта в zabbix](https://serveradmin.ru/wp-content/uploads/2019/03/zabbix-site-monitoring-23.png)](https://serveradmin.ru/wp-content/uploads/2019/03/zabbix-site-monitoring-23.png)