## НАСТРОЙКА LOGROTATE

Logrotate - это популярная утилита, поэтому в большинстве дистрибутивов она поставляется по умолчанию. Вы можете убедиться, что программа установлена в вашем дистрибутиве, попытавшись ее установить. Например, в CentOS:

 `sudo yum install logrotate`

![](https://losst.ru/wp-content/uploads/2017/04/Snimok-ekrana-iz-2017-04-20-13-36-05-1024x576.png)

Или в Ubuntu и основанных на ней дистрибутивах:

 `sudo apt install logrotate`

Теперь, даже если утилита не была установлена, вы ее установите. Все основные настройки программы находятся в файле /etc/logrotate.conf, дополнительные настройки, касаемо правил и других возможностей могут быть размещены в папке /etc/logroate.d/. Вы можете размещать все настройки logroatae прямо в основном конфигурационном файле, будет более правильно, если настройки для каждого отдельного сервиса будут находиться в отдельном файле, в папке /etc/logrotate.d/.

Чтобы конфигурационные файлы из этой папки загружались программой, необходимо добавить в основной конфигурационный файл такую строчку:

 `vi /etc/logrotate.conf`

`include /etc/logrotate.d`

[![](https://losst.ru/wp-content/uploads/2017/04/Snimok-ekrana-iz-2017-04-20-13-43-05-1024x576.png)](https://losst.ru/wp-content/uploads/2017/04/Snimok-ekrana-iz-2017-04-20-13-43-05.png)

Просто убедитесь что она там уже есть. Сначала давайте рассмотрим основные директивы, которые мы будем применять во время настройки. Здесь директивы выглядят не совсем обычно, сама директива и определяет что и когда нужно делать, а уже если нужно, ей передаются дополнительные параметры. Чтобы указать как часто нужно выполнять проверку совпадению условий используются такие директивы:

-   **hourly** - каждый час;
-   **daily** - каждый день;
-   **weekly** - каждую неделю;
-   **monthly** - каждый месяц;
-   **yearly** - каждый год.

Основные директивы управления и обработки логов:

-   **rotate** - указывает сколько старых логов нужно хранить, в параметрах передается количество;
-   **create** - указывает, что необходимо создать пустой лог файл после перемещения старого;
-   **dateext** - добавляет дату ротации перед заголовком старого лога;
-   **compress** - указывает, что лог необходимо сжимать;
-   **delaycompress** - не сжимать последний и предпоследний журнал;
-   **extension** - сохранять оригинальный лог файл после ротации, если у него указанное расширение;
-   **mail** - отправлять Email после завершения ротации;
-   **maxage** - выполнять ротацию журналов, если они старше, чем указано;
-   **missingok** - не выдавать ошибки, если лог файла не существует;
-   **olddir** - перемещать старые логи в отдельную папку;
-   **postrotate/endscript** - выполнить произвольные команды после ротации;
-   **start** - номер, с которого будет начата нумерация старых логов;
-   **size** - размер лога, когда он будет перемещен;

Это те основные директивы, которые мы будем использовать. В главном конфигурационном файле находится глобальная конфигурация, директивы, которые будут распространяться на все логи если не было отменено их действие. Каждый лог, который подлежит ротации описывается таким образом:

**адрес_файла_лога {**  
**директивы**  
**}**

Теперь давайте создадим файл rsyslog.conf в папке /etc/logrotate.d/ и поместим в него настройки для ротации этого лога:

`/var/log/messages {  
daily  
rotate 3  
size 10M  
compress  
delaycompress  
}`

[![](https://losst.ru/wp-content/uploads/2017/04/Snimok-ekrana-iz-2017-04-20-14-30-52-1024x576.png)](https://losst.ru/wp-content/uploads/2017/04/Snimok-ekrana-iz-2017-04-20-14-30-52.png)

Эти настройки означают, что ротация журналов будет выполняться ежедневно, и мы будем хранить три последних журнала, более старые копии будут автоматически удаляться. Минимальный размер для ротации - 10 мегабайт, ротация не будет выполнена, если лог не занимает более 10 мегабайт. Будет использоваться сжатие, для всех журналов кроме последнего и предпоследнего. Точно по такому же принципу вы можете настроить ротацию логов для любого из журналов. Нужно создать такую секцию для каждого из логов, которыми вы хотите управлять.

Теперь осталось протестировать как работает наша конфигурация. Для этого запустим утилиту logrotate с опцией -d. Она выведет все, что планируется сделать, но не будет изменять файлы на диске. У нас есть файл /var/log/messages, размером 40 Мегабайт, посмотрим что будет делать утилита:

 `logrotate -d /etc/logrotate.d/rsyslog.conf`

[![](https://losst.ru/wp-content/uploads/2017/04/Snimok-ekrana-iz-2017-04-20-14-35-50-1024x576.png)](https://losst.ru/wp-content/uploads/2017/04/Snimok-ekrana-iz-2017-04-20-14-35-50.png)[![](https://losst.ru/wp-content/uploads/2017/04/Snimok-ekrana-iz-2017-04-20-14-37-13-1024x576.png)](https://losst.ru/wp-content/uploads/2017/04/Snimok-ekrana-iz-2017-04-20-14-37-13.png)

Как видите, программа обнаруживает файл лога и разделяет его на несколько частей. Вы можете убедиться, что logrotate будет запускаться как положено проверив расписание cron:

 `ls /etc/cron.daily/`

[![](https://losst.ru/wp-content/uploads/2017/04/Snimok-ekrana-iz-2017-04-20-14-41-25-1024x576.png)](https://losst.ru/wp-content/uploads/2017/04/Snimok-ekrana-iz-2017-04-20-14-41-25.png)

Настройка Logrotate завершена, а вам осталось всего лишь расписать как будет выполняться ротация логов для каждого из журналов, которые занимают много места.